<!DOCTYPE html> <html lang="en-us"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content=""> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Shrink WSL2 and Docker Virtual Disks to Reclaim Disk Space | David Quispe </title> <meta name="author" content="David Quispe"> <meta name="description" content="Complete guide to reclaim disk space by optimizing WSL2 and Docker VHDX files. Learn how to manually shrink virtual disks and improve storage efficiency."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <meta property="og:site_name" content="David Quispe"> <meta property="og:type" content="article"> <meta property="og:title" content="David Quispe | Shrink WSL2 and Docker Virtual Disks to Reclaim Disk Space"> <meta property="og:url" content="https://mcdaqc.github.io/blog/2025/shrink-wsl2-docker-virtual-disks/"> <meta property="og:description" content="Complete guide to reclaim disk space by optimizing WSL2 and Docker VHDX files. Learn how to manually shrink virtual disks and improve storage efficiency."> <meta property="og:image" content="assets\img\prof_pic.jpg"> <meta property="og:locale" content="en-us"> <meta name="twitter:card" content="summary"> <meta name="twitter:title" content="Shrink WSL2 and Docker Virtual Disks to Reclaim Disk Space"> <meta name="twitter:description" content="Complete guide to reclaim disk space by optimizing WSL2 and Docker VHDX files. Learn how to manually shrink virtual disks and improve storage efficiency."> <meta name="twitter:image" content="assets\img\prof_pic.jpg"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/icon2.ico?5cbdf51c7dfc7fae00deb40859565327"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://mcdaqc.github.io/blog/2025/shrink-wsl2-docker-virtual-disks/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">David</span> Quispe </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/resume/">resume </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Shrink WSL2 and Docker Virtual Disks to Reclaim Disk Space</h1> <p class="post-meta"> Created in January 07, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a> ¬† ¬∑ ¬† <a href="/blog/tag/wsl2"> <i class="fa-solid fa-hashtag fa-sm"></i> wsl2</a> ¬† <a href="/blog/tag/docker"> <i class="fa-solid fa-hashtag fa-sm"></i> docker</a> ¬† <a href="/blog/tag/windows"> <i class="fa-solid fa-hashtag fa-sm"></i> windows</a> ¬† <a href="/blog/tag/virtualization"> <i class="fa-solid fa-hashtag fa-sm"></i> virtualization</a> ¬† <a href="/blog/tag/disk-management"> <i class="fa-solid fa-hashtag fa-sm"></i> disk-management</a> ¬† ¬∑ ¬† <a href="/blog/category/tutorials"> <i class="fa-solid fa-tag fa-sm"></i> tutorials</a> ¬† <a href="/blog/category/system-administration"> <i class="fa-solid fa-tag fa-sm"></i> system-administration</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Over time, WSL2 distributions and Docker images can consume significant disk space on your Windows system. Even after deleting files, containers, or images, the allocated virtual disk (VHDX) files do not automatically shrink to reflect the freed space. This comprehensive guide explains how to manually reclaim disk space by optimizing these virtual disks.</p> <h2 id="understanding-the-problem">Understanding the Problem</h2> <p>WSL2 and Docker Desktop use VHDX (Virtual Hard Disk) files to store their data. These files have a tendency to grow but rarely shrink automatically, leading to:</p> <ul> <li> <strong>Wasted disk space</strong> even after cleanup</li> <li> <strong>Performance degradation</strong> on systems with limited storage</li> <li> <strong>Unexpected ‚Äúdisk full‚Äù errors</strong> despite having deleted content</li> </ul> <p>The solution is to manually optimize these VHDX files using Windows‚Äô built-in tools.</p> <h2 id="shrinking-wsl2-virtual-disks">Shrinking WSL2 Virtual Disks</h2> <h3 id="step-1-locate-the-vhdx-file">Step 1: Locate the VHDX File</h3> <p>On Windows 11, WSL2 distributions store their virtual disks in the following location:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\[username]\AppData\Local\Packages\
</code></pre></div></div> <p>Look for the vendor name corresponding to your installed distribution:</p> <table> <thead> <tr> <th>Distribution</th> <th>Vendor Folder</th> </tr> </thead> <tbody> <tr> <td><strong>Ubuntu</strong></td> <td><code class="language-plaintext highlighter-rouge">CanonicalGroupLimited.Ubuntu*</code></td> </tr> <tr> <td><strong>Debian</strong></td> <td><code class="language-plaintext highlighter-rouge">TheDebianProject.DebianGNULinux*</code></td> </tr> <tr> <td><strong>Pengwin</strong></td> <td><code class="language-plaintext highlighter-rouge">WhitewaterFoundryLtd.Co.Pengwin*</code></td> </tr> <tr> <td><strong>openSUSE</strong></td> <td><code class="language-plaintext highlighter-rouge">46932SUSE.openSUSE*</code></td> </tr> </tbody> </table> <p>Once you identify the correct folder, navigate to the <code class="language-plaintext highlighter-rouge">LocalState</code> subdirectory, where you will find the <code class="language-plaintext highlighter-rouge">ext4.vhdx</code> file for the distribution.</p> <h3 id="step-2-prepare-for-optimization">Step 2: Prepare for Optimization</h3> <p>Before optimizing the VHDX file, ensure you:</p> <ol> <li> <strong>Save your work</strong> and close all WSL2 sessions</li> <li> <strong>Stop all running containers</strong> if using Docker</li> <li> <strong>Create a backup</strong> of important data (optional but recommended)</li> </ol> <h3 id="step-3-optimize-the-virtual-disk">Step 3: Optimize the Virtual Disk</h3> <ol> <li> <strong>Shut down WSL2 completely:</strong> <div class="language-powershell highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="n">wsl</span><span class="w"> </span><span class="nt">--shutdown</span><span class="w">
</span></code></pre></div> </div> </li> <li> <strong>Open PowerShell as Administrator</strong> and run the optimization command: <div class="language-powershell highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="n">optimize-vhd</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"C:\Users\[username]\AppData\Local\Packages\[vendor-folder]\LocalState\ext4.vhdx"</span><span class="w"> </span><span class="nt">-Mode</span><span class="w"> </span><span class="nx">full</span><span class="w">
</span></code></pre></div> </div> <p><strong>Example for Ubuntu:</strong></p> <div class="language-powershell highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="n">optimize-vhd</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"C:\Users\johndoe\AppData\Local\Packages\CanonicalGroupLimited.Ubuntu22.04LTS_79rhkp1fndgsc\LocalState\ext4.vhdx"</span><span class="w"> </span><span class="nt">-Mode</span><span class="w"> </span><span class="nx">full</span><span class="w">
</span></code></pre></div> </div> </li> </ol> <h2 id="shrinking-docker-virtual-disks">Shrinking Docker Virtual Disks</h2> <h3 id="step-1-locate-dockers-virtual-disks">Step 1: Locate Docker‚Äôs Virtual Disks</h3> <p>Docker Desktop stores its virtual disk files for WSL2 in these locations:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\[YOURNAME]\AppData\Local\Docker\wsl\disk\
C:\Users\[YOURNAME]\AppData\Local\Docker\wsl\data\
</code></pre></div></div> <p>The main files you‚Äôll typically find:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">data.vhdx</code> - Contains Docker images and containers</li> <li> <code class="language-plaintext highlighter-rouge">disk.vhdx</code> - Contains Docker‚Äôs Linux filesystem</li> </ul> <h3 id="step-2-clean-docker-resources-optional">Step 2: Clean Docker Resources (Optional)</h3> <p>Before shrinking, consider cleaning up unused Docker resources:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Remove unused containers, networks, images, and volumes</span>
docker system prune <span class="nt">-a</span> <span class="nt">--volumes</span>

<span class="c"># Remove specific items</span>
docker container prune  <span class="c"># Remove stopped containers</span>
docker image prune <span class="nt">-a</span>   <span class="c"># Remove unused images</span>
docker volume prune     <span class="c"># Remove unused volumes</span>
</code></pre></div></div> <h3 id="step-3-optimize-docker-virtual-disks">Step 3: Optimize Docker Virtual Disks</h3> <ol> <li> <strong>Shut down Docker completely:</strong> <div class="language-powershell highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="n">wsl</span><span class="w"> </span><span class="nt">--shutdown</span><span class="w">
</span></code></pre></div> </div> </li> <li> <p><strong>Close Docker Desktop</strong> from the system tray</p> </li> <li> <strong>Open PowerShell as Administrator</strong> and optimize both VHDX files: <div class="language-powershell highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="c"># Optimize data disk</span><span class="w">
</span><span class="n">optimize-vhd</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"C:\Users\[YOURNAME]\AppData\Local\Docker\wsl\data\ext4.vhdx"</span><span class="w"> </span><span class="nt">-Mode</span><span class="w"> </span><span class="nx">full</span><span class="w">
   
</span><span class="c"># Optimize disk if present</span><span class="w">
</span><span class="n">optimize-vhd</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"C:\Users\[YOURNAME]\AppData\Local\Docker\wsl\disk\disk.vhdx"</span><span class="w"> </span><span class="nt">-Mode</span><span class="w"> </span><span class="nx">full</span><span class="w">
</span></code></pre></div> </div> </li> </ol> <h2 id="advanced-tips-and-troubleshooting">Advanced Tips and Troubleshooting</h2> <h3 id="monitoring-disk-usage">Monitoring Disk Usage</h3> <p>Before and after optimization, check the actual file sizes:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Check VHDX file size</span><span class="w">
</span><span class="n">Get-ChildItem</span><span class="w"> </span><span class="s2">"C:\Users\[username]\AppData\Local\Packages\*\LocalState\*.vhdx"</span><span class="w"> </span><span class="o">|</span><span class="w"> 
    </span><span class="n">Select-Object</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="p">@{</span><span class="nx">Name</span><span class="o">=</span><span class="s2">"Size(GB)"</span><span class="p">;</span><span class="nx">Expression</span><span class="o">=</span><span class="p">{[</span><span class="n">math</span><span class="p">]::</span><span class="n">Round</span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Length</span><span class="n">/1GB</span><span class="p">,</span><span class="nx">2</span><span class="p">)}}</span><span class="w">
</span></code></pre></div></div> <h3 id="alternative-using-diskpart">Alternative: Using diskpart</h3> <p>If <code class="language-plaintext highlighter-rouge">optimize-vhd</code> is not available, you can use <code class="language-plaintext highlighter-rouge">diskpart</code>:</p> <pre><code class="language-cmd">diskpart
select vdisk file="C:\path\to\your\file.vhdx"
compact vdisk
exit
</code></pre> <h3 id="preventing-future-bloat">Preventing Future Bloat</h3> <ol> <li> <strong>Regular cleanup:</strong> Schedule periodic cleanup of unused Docker resources</li> <li> <strong>Use .dockerignore:</strong> Prevent unnecessary files from being included in images</li> <li> <strong>Multi-stage builds:</strong> Use Docker multi-stage builds to reduce final image size</li> <li> <strong>WSL2 management:</strong> Regularly clean up packages and logs in WSL2 distributions</li> </ol> <h3 id="troubleshooting-common-issues">Troubleshooting Common Issues</h3> <p><strong>‚ÄúAccess Denied‚Äù Error:</strong></p> <ul> <li>Ensure PowerShell is running as Administrator</li> <li>Make sure WSL2 and Docker are completely shut down</li> <li>Check if any antivirus software is locking the files</li> </ul> <p><strong>‚ÄúFile is in use‚Äù Error:</strong></p> <ul> <li>Run <code class="language-plaintext highlighter-rouge">wsl --shutdown</code> and wait 10-15 seconds</li> <li>Close Docker Desktop completely</li> <li>Check Task Manager for any remaining <code class="language-plaintext highlighter-rouge">wsl.exe</code> or <code class="language-plaintext highlighter-rouge">docker</code> processes</li> </ul> <p><strong>Limited Space Reclaimed:</strong></p> <ul> <li>Some VHDX files have minimum size limits</li> <li>Recent file writes may prevent significant shrinking</li> <li>Consider the VHDX file‚Äôs allocation unit size</li> </ul> <h2 id="performance-impact-and-results">Performance Impact and Results</h2> <p>After optimization, you should expect:</p> <ul> <li> <strong>Significant disk space recovery</strong> (often 50-80% reduction)</li> <li> <strong>Faster boot times</strong> for WSL2 distributions</li> <li> <strong>Improved overall system performance</strong> on storage-constrained systems</li> <li> <strong>Better Docker performance</strong> due to optimized disk access</li> </ul> <h2 id="conclusion">Conclusion</h2> <p>Regular maintenance of WSL2 and Docker VHDX files is essential for optimal system performance and storage management. By following this guide, you can reclaim substantial disk space and maintain a clean, efficient development environment.</p> <p>The optimization process is safe and can be performed regularly without data loss, though creating backups of critical data is always recommended as a best practice.</p> <hr> <p><strong>üìù Original Gist:</strong> This tutorial is based on my <a href="https://gist.github.com/mcdaqc/563c7a92af8da9d911b4f358858d8504" rel="external nofollow noopener" target="_blank">original GitHub Gist</a> with expanded content and additional troubleshooting tips.</p> <p><strong>Pro Tip:</strong> Consider creating a PowerShell script to automate this process for multiple VHDX files, making regular maintenance even easier!</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/private-synthetic-data-generation-made-easy-out-of-the-box-with-docker-argilla-ollama/">Private Synthetic Data Generation Made Easy: Out-of-the-Box with Docker, Argilla &amp; Ollama</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/shrink-wsl2-and-docker-virtual-disks-to-reclaim-disk-space-github/">Shrink WSL2 and Docker Virtual Disks to Reclaim Disk Space ¬∑ GitHub</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/private-synthetic-data-generation-made-easy-out-of-the-box-with-docker-argilla-ollama/">Private Synthetic Data Generation Made Easy: Out-of-the-Box with Docker, Argilla &amp; Ollama</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/instant-dark-theme-browser-devtools/">Instant Dark Theme for Any Website Using Browser DevTools</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> ¬© Copyright 2025 David Quispe. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id="></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> </body> </html>